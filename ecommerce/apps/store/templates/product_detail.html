{% extends 'base.html' %}

{% block title %} | {{ product.title }}{% endblock %}

{% block content %}
<div id="productapp">
  <img :src="mainImage">
  <hr>
  <div class="columns">
    <div class="column is-2" v-for="image in images">
      <figure class="image is-128x128">
        <img :src="image.thumbnail" @click="changeMainImage(image.image)">
      </figure>
    </div>
  </div>
  <hr>
  <h1 class="title">{{ product.title }}</h1>
  <h2 class="subtitle"> ${{ product.price }}</h2>

  {% if product.description %}
  <p> {{ product.description }}</p>
  {% endif %}

  {% if product.in_cart %}
  <p>Already in cart!</p>
  {% else %}
    {% if product.num_available > 0 %}
    <button @click=addToCart({{ product.id }})>Add to cart</button>
    {% else %}
    <p>The product in out of stock</p>
    {% endif %}
  {% endif %}

  <article class="message is-success" v-if="showMessage">
    <div class="message-body">
      <p>The product was added to the cart!</p>
    </div>
  </article>
</div>
{% endblock content %}

{% block scripts %}
<script>
  const productapp = new Vue({
    el: '#productapp',
    store: store,
    delimeters: ['[[', ']]'],
    data() {
      return {
        showMessage: false,
        // this Will NOt work but make equivalence on the front end but via api
        mainImage: '{{ Product.image.url }}',
        images: [{{ imagesstring|safe }}]
      }
    },
    mounted() {
      console.log('mounted');
    },
    methods: {
      changeMainImage(image) {
        this.mainImage = image;
      },
      addToCart(product_id) {
        console.log('product_id:', product_id);

        let data = {
          'product_id': product_id,
          'update': false,
          'quantity': 1
        }

        fetch('/api/add_to_cart/', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFTOKEN': '{{ csrf_token }}'
            },
            credentials: 'same-origin',
            body: JSON.stringify(data)
          })
          .then((response) => {
            console.log(response);

            this.showMessage = true;

            store.commit('increment', 1);

            setTimeout(() => {
              this.showMessage = false
            }, 2000)

          })
          .catch((error) => {
            console.log('Error', error)
          })
      },
    },
  });
</script>
{% endblock scripts %}